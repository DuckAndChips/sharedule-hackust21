<!DOCTYPE html>
<html lang="en" dir="ltr">

    <head>
        <meta charset="utf-8">
        <title>Family To-do List</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="jq/external/jquery/jquery.js"></script>
        <link href='jq/jquery-ui.css' rel='stylesheet' />
        <script src='jq/jquery-ui.js'></script>

        <script type="text/javascript">

            document.addEventListener('DOMContentLoaded', function() {

                // Check for the existence of parent account and login status
                loginUpdate = () => {
                    $(".forms").attr("hidden", "true");
                    fetch('/todo/init')
                    .then(response => response.json())
                    .then((parsedResponse) => {
                        console.log(parsedResponse);
                        if(parsedResponse.hasAcc){
                            if(parsedResponse.hasLoggedIn){
                                $(".entry-form").removeAttr("hidden");
                                $(".settings").removeAttr("disabled");
                            } else {
                                $(".login").removeAttr("hidden");
                            }
                        } else {
                            $(".new-login").removeAttr("hidden");
                        }
                    })
                };
                loginUpdate();

                // Create account
                $("#create-pw-submit").click(() => {
                    let pwData = {
                        pw: $("#create-pw-input").val(),
                        hasLoggedIn: false
                    }
                    fetch('/todo/create-pw', {
                        method: 'POST',
                        body: JSON.stringify(pwData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        alert("Account created succesfully.")
                        loginUpdate();
                    });
                });

                // Login Account
                $("#login-pw-submit").click(() => {
                    let pwData = {
                        pw: $("#login-pw-input").val()
                    };
                    fetch('/todo/login', {
                        method: 'POST',
                        body: JSON.stringify(pwData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then( parsedResponse => {
                        if (parsedResponse.success) {
                            loginUpdate();
                        } else {
                            alert("Wrong password.");
                        };
                    });
                });

                // Logout account
                $("#logout").click(() => {
                    fetch('/todo/logout').then( response => loginUpdate() );
                    $(".settings").attr("disabled", "true");
                });

                // Load tasks
                loadTasks = () => {
                    fetch('/todo/load')
                    .then(response => response.json())
                    .then(parsedResponse => {
                        if(parsedResponse.length){
                            $(".empty-todo").attr("hidden", "true");
                            $(".todolist").removeAttr("hidden");
                            $(".todolist").empty();
                            for(const doc of parsedResponse){
                                $(".todolist").append("<tr id=\"" + doc._id + "\"><th class=\"todo-name\">" + doc.name + "</th><th class=\"todo-pic\">" + doc.pic + "</th><th> <input type=\"checkbox\" class=\"check\" id=\"" + doc._id + "\" " + (doc.checked ? "checked" : "") + "> </th><th> <button class=\"settings\" type=\"button\" id=\"" + doc._id + "\" disabled> âš™ </button> </th></tr>");
                                $(".todolist").on("click", ".settings#" + doc._id, () => {
                                    $(".edit-dialog").removeAttr("hidden");
                                    $(".edit-dialog").attr("id", doc._id);
                                    $(".settings").attr("disabled", true);
                                    $("#edit-name").val( doc.name );
                                    $("#edit-pic").val( doc.pic );
                                    $(".edit-dialog").dialog({
                                        close: () => {
                                            $(".settings").removeAttr("disabled");
                                        }
                                    });
                                });
                                $(".check#" + doc._id).on("change", () => {
                                    console.log($(".check#" + doc._id).prop('checked'));
                                    fetch('/todo/check', {
                                        method: 'POST',
                                        body: JSON.stringify({ _id: doc._id, checked: $(".check#" + doc._id).prop('checked') }),
                                        headers: {
                                            'Content-Type': 'application/json'
                                        }
                                    }).then(response => loadTasks());
                                });
                            };
                            loginUpdate();
                        } else {
                            $(".empty-todo").removeAttr("hidden");
                            $(".todolist").attr("hidden", "true");
                        };
                    });
                };
                loadTasks();

                // Create task
                $("#task-submit").click(() => {
                    let taskData = {
                        name: $("#task-name").val(),
                        pic: $("#task-pic").val(),
                        checked: false
                    };
                    fetch('/todo/add', {
                        method: 'POST',
                        body: JSON.stringify(taskData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(parsedResponse => {
                        $("#task-name").val("");
                        $("#task-pic").val("");
                        loadTasks();
                    });
                });

                // Edit task

                $("#edit-submit").click(() => {
                    let editData = {
                        name: $("#edit-name").val(),
                        pic: $("#edit-pic").val(),
                        _id: $(".edit-dialog").attr("id")
                    }
                    console.log(editData);
                    fetch('/todo/edit', {
                        method: 'POST',
                        body: JSON.stringify(editData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => loadTasks());
                    $(".edit-dialog").dialog("close");
                });

                $("#edit-delete").click(() => {
                    let deleteData = {
                        _id: $(".edit-dialog").attr("id")
                    }
                    fetch('/todo/delete', {
                        method: 'POST',
                        body: JSON.stringify(deleteData),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => loadTasks());
                    $(".edit-dialog").dialog("close");
                });

                $("#edit-cancel").click(() => {
                    $(".edit-dialog").dialog("close");
                });

            });

        </script>

    </head>

    <body style="text-align: center; font-family: sans-serif; margin: 50px 100px 50px 100px">

        <h2>To-do list</h2>

        <!-- Empty to do list label -->
        <p class="empty-todo" hidden>There are currently no tasks in the to-do list. Create tasks using a parents account.</p>

        <!-- To do list table -->
        <table class="table m-auto">
            <thead>
                <tr>
                    <th class="top-row" scope="col">Task</th>
                    <th class="top-row" scope="col">Person-in-charge</th>
                    <th class="top-row" scope="col">Checked</th>
                    <th class="top-row" scope="col">Settings</th>
                </tr>
            </thead>
            <tbody class="todolist">
            </tbody>
        </table>

        <br/> <br/>

        <!-- Create Password -->
        <div class="forms new-login" hidden>
            <p>A parent account has not yet been created. Type in a password and create a parent account. Changes can only be made using the parent account.</p>
            <div class="input-group mb-3">
                <span class="input-group-text">Password:</span>
                <input id="create-pw-input" type="text" class="form-control" />
            </div>
                <button class="btn btn-primary" id="create-pw-submit" type="button">Confirm</button>
        </div>

        <!-- Login form -->
        <div class="forms login" hidden>
            <p> Check the boxes to cross out tasks. Login into a parent account to make changes. </p>
            <div class="input-group mb-3">
                <span class="input-group-text">Password:</span>
                <input id="login-pw-input" class="form-control" type="text" />
                <button class="btn btn-primary" id="login-pw-submit" type="button">Confirm</button>
            </div>
        </div>

        <!-- Entry form -->
        <div class="forms entry-form" hidden>
            <p> Logged into parent account. <button id="logout" type="button" class="btn btn-outline-primary">Logout</button> </p>
            <br/>
            <div class="mx-5">
                <div class="input-group mb-3">
                    <span class="input-group-text">Task Name:</span>
                    <input id="task-name" type="text" class="form-control" />
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">Person-in-charge:</span>
                    <input id="task-pic" type="text" class="form-control" />
                </div>
                <button class="btn btn-primary" id="task-submit" type="button">Add Task</button>
            </div>
        </div>

        <!-- Edit Dialog -->
        <div class="edit-dialog" id="" hidden>
            <label for="edit-name">New Task Name:</label>
            <input id="edit-name" type="text" /> <br/> <br/>
            <label for="edit-pic">New Person-in-charge:</label>
            <input id="edit-pic" type="text" /> <br/> <br/>
            <button id="edit-submit" type="button">Save Changes</button>
            <button id="edit-delete" type="button">Delete</button>
            <button id="edit-cancel" type="button">Cancel</button>
        </div>

        <br/><br/>

        <a class="btn btn-outline-primary" id="back-to-main-menu" type="button" href="index.html">Back to Main Menu</a>

    </body>
</html>
